# home/tasks.py

import socket
import ssl
from celery import shared_task
import requests

@shared_task
def port_scan(domain):
    common_ports = [20, 21, 22, 23, 25, 53, 80, 81, 110, 143, 443, 465, 587, 3306, 3389, 5432, 6379, 8080, 8443]  # List of common ports
    open_ports = []
    
    for port in common_ports:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
            s.settimeout(1)  # Set a timeout of 1 second for the connection attempt
            result = s.connect_ex((domain, port))  # Attempt to connect to the port
            
            if result == 0:  # If result is 0, the port is open
                open_ports.append(port)
    
    return open_ports

@shared_task
def check_security_configuration(domain):
    # Example check: Requesting the URL and checking security headers
    response = requests.get(f'http://{domain}', timeout=5)
    missing_headers = []
    expected_headers = ['X-Content-Type-Options', 'X-Frame-Options', 'X-XSS-Protection']
    
    for header in expected_headers:
        if header not in response.headers:
            missing_headers.append(header)
    
    return missing_headers

@shared_task
def check_ssl_certification(domain):
    try:
        cert = ssl.get_server_certificate((domain, 443))
        return "SSL Certificate is valid."
    except Exception as e:
        return f"SSL Certificate error: {str(e)}"
